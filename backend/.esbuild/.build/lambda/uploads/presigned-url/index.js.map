{
  "version": 3,
  "sources": ["../../../../../lambda/uploads/presigned-url/index.ts", "../../../../../node_modules/uuid/dist/esm-node/rng.js", "../../../../../node_modules/uuid/dist/esm-node/stringify.js", "../../../../../node_modules/uuid/dist/esm-node/native.js", "../../../../../node_modules/uuid/dist/esm-node/v4.js"],
  "sourcesContent": ["import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\nimport { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\nimport { v4 as uuidv4 } from 'uuid';\n\nconst s3Client = new S3Client({\n  region: process.env.AWS_REGION || 'us-east-1',\n  ...(process.env.STAGE === 'local' && {\n    endpoint: 'http://localhost:9000',\n    credentials: {\n      accessKeyId: 'minioadmin',\n      secretAccessKey: 'minioadmin',\n    },\n    forcePathStyle: true,\n  }),\n});\n\nexport const handler = async (\n  event: APIGatewayProxyEvent\n): Promise<APIGatewayProxyResult> => {\n  try {\n    console.log('=== UPLOAD PRESIGNED URL REQUEST ===');\n\n    if (!event.body) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'Request body is required' }),\n      };\n    }\n\n    const body = JSON.parse(event.body);\n    const { fileName, fileType, uploadType = 'video' } = body;\n\n    if (!fileName || !fileType) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'fileName and fileType are required' }),\n      };\n    }\n\n    const fileId = uuidv4();\n    const fileExtension = fileName.split('.').pop();\n    const key = `videos/${fileId}.${fileExtension}`;\n    const bucket = uploadType === 'video' ? 'course-videos' : 'course-thumbnails';\n\n    console.log('Generating presigned URL for:', { bucket, key, fileType });\n\n    const command = new PutObjectCommand({\n      Bucket: bucket,\n      Key: key,\n      ContentType: fileType,\n    });\n\n    // Generate presigned URL with simpler signing\n    const uploadUrl = await getSignedUrl(s3Client, command, { \n      expiresIn: 3600,\n      signableHeaders: new Set(['host']),\n      unhoistableHeaders: new Set()\n    });\n    \n    const publicUrl = `http://localhost:9000/${bucket}/${key}`;\n\n    console.log('Generated URLs');\n\n    return {\n      statusCode: 200,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({\n        uploadUrl,\n        publicUrl,\n        key,\n        bucket,\n        fileId,\n      }),\n    };\n  } catch (error) {\n    console.error('ERROR:', error);\n    return {\n      statusCode: 500,\n      headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n      body: JSON.stringify({\n        error: 'Internal server error',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      }),\n    };\n  }\n};\n", "import crypto from 'crypto';\nconst rnds8Pool = new Uint8Array(256); // # of random values to pre-allocate\n\nlet poolPtr = rnds8Pool.length;\nexport default function rng() {\n  if (poolPtr > rnds8Pool.length - 16) {\n    crypto.randomFillSync(rnds8Pool);\n    poolPtr = 0;\n  }\n\n  return rnds8Pool.slice(poolPtr, poolPtr += 16);\n}", "import validate from './validate.js';\n/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\n\nconst byteToHex = [];\n\nfor (let i = 0; i < 256; ++i) {\n  byteToHex.push((i + 0x100).toString(16).slice(1));\n}\n\nexport function unsafeStringify(arr, offset = 0) {\n  // Note: Be careful editing this code!  It's been tuned for performance\n  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434\n  return byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]];\n}\n\nfunction stringify(arr, offset = 0) {\n  const uuid = unsafeStringify(arr, offset); // Consistency check for valid UUID.  If this throws, it's likely due to one\n  // of the following:\n  // - One or more input array values don't map to a hex octet (leading to\n  // \"undefined\" in the uuid)\n  // - Invalid input values for the RFC `version` or `variant` fields\n\n  if (!validate(uuid)) {\n    throw TypeError('Stringified UUID is invalid');\n  }\n\n  return uuid;\n}\n\nexport default stringify;", "import crypto from 'crypto';\nexport default {\n  randomUUID: crypto.randomUUID\n};", "import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\n\nfunction v4(options, buf, offset) {\n  if (native.randomUUID && !buf && !options) {\n    return native.randomUUID();\n  }\n\n  options = options || {};\n  const rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n\n  rnds[6] = rnds[6] & 0x0f | 0x40;\n  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided\n\n  if (buf) {\n    offset = offset || 0;\n\n    for (let i = 0; i < 16; ++i) {\n      buf[offset + i] = rnds[i];\n    }\n\n    return buf;\n  }\n\n  return unsafeStringify(rnds);\n}\n\nexport default v4;"],
  "mappings": "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",
  "names": ["crypto", "import_crypto", "crypto"]
}

{
  "version": 3,
  "sources": ["../../../../../lambda/payments/confirm-payment/index.ts", "../../../../../node_modules/uuid/dist/esm-node/rng.js", "../../../../../node_modules/uuid/dist/esm-node/stringify.js", "../../../../../node_modules/uuid/dist/esm-node/native.js", "../../../../../node_modules/uuid/dist/esm-node/v4.js"],
  "sourcesContent": ["\nimport { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, PutCommand, UpdateCommand, GetCommand } from '@aws-sdk/lib-dynamodb';\nimport { v4 as uuidv4 } from 'uuid';\n\nconst dynamoClient = new DynamoDBClient({\n  region: process.env.AWS_REGION || 'us-east-1',\n  ...(process.env.STAGE === 'local' && {\n    endpoint: 'http://localhost:8000',\n    credentials: { accessKeyId: 'local', secretAccessKey: 'local' },\n  }),\n});\n\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\n\nexport const handler = async (\n  event: APIGatewayProxyEvent\n): Promise<APIGatewayProxyResult> => {\n  try {\n    if (!event.body) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'Request body is required' }),\n      };\n    }\n\n    const body = JSON.parse(event.body);\n    const { paymentIntentId, courseId, amount, couponCode } = body;\n    const userId = 'user123'; // TODO: Get from JWT\n    const now = new Date().toISOString();\n\n    // Get course details\n    const course = await docClient.send(\n      new GetCommand({\n        TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n        Key: { PK: `COURSE#${courseId}`, SK: 'METADATA' },\n      })\n    );\n\n    if (!course.Item) {\n      return {\n        statusCode: 404,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'Course not found' }),\n      };\n    }\n\n    // In production, verify payment with Stripe\n    // For now, assume payment is successful\n\n    const paymentId = uuidv4();\n\n    // Create payment record\n    const paymentData = {\n      PK: `USER#${userId}`,\n      SK: `PAYMENT#${paymentId}`,\n      EntityType: 'Payment',\n      paymentId,\n      userId,\n      courseId,\n      courseTitle: course.Item.title,\n      \n      amount,\n      currency: course.Item.currency,\n      originalPrice: course.Item.price,\n      discountApplied: (course.Item.price || 0) - amount,\n      couponCode: couponCode || null,\n      \n      paymentMethod: 'CREDIT_CARD',\n      paymentProcessor: 'Stripe',\n      transactionId: paymentIntentId,\n      \n      status: 'COMPLETED',\n      \n      billingDetails: body.billingDetails || {},\n      \n      createdAt: now,\n      completedAt: now,\n      \n      GSI1PK: `USER#${userId}#PAYMENTS`,\n      GSI1SK: `DATE#${now}`,\n      GSI2PK: `COURSE#${courseId}#PAYMENTS`,\n      GSI2SK: `DATE#${now}`,\n      GSI3PK: 'PAYMENTS',\n      GSI3SK: `DATE#${now}#PAY#${paymentId}`,\n    };\n\n    await docClient.send(\n      new PutCommand({\n        TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n        Item: paymentData,\n      })\n    );\n\n    // Update coupon usage if used\n    if (couponCode) {\n      await docClient.send(\n        new UpdateCommand({\n          TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n          Key: { PK: `COUPON#${couponCode}`, SK: 'METADATA' },\n          UpdateExpression: 'SET usedCount = usedCount + :inc',\n          ExpressionAttributeValues: { ':inc': 1 },\n        })\n      );\n    }\n\n    // Create enrollment\n    const enrollmentId = uuidv4();\n    const enrollmentData = {\n      PK: `USER#${userId}`,\n      SK: `ENROLLMENT#${courseId}`,\n      EntityType: 'Enrollment',\n      enrollmentId,\n      userId,\n      courseId,\n      courseTitle: course.Item.title,\n      courseThumbnail: course.Item.thumbnail,\n      instructorName: course.Item.instructorName,\n      \n      enrolledAt: now,\n      lastAccessedAt: now,\n      status: 'ACTIVE',\n      \n      progress: {\n        completedLessons: 0,\n        totalLessons: course.Item.totalLessons,\n        completionPercentage: 0,\n      },\n      \n      paymentId: `PAYMENT#${paymentId}`,\n      amountPaid: amount,\n      currency: course.Item.currency,\n      \n      certificateIssued: false,\n      certificateId: null,\n      expiresAt: null,\n      \n      GSI1PK: `USER#${userId}#ENROLLMENTS`,\n      GSI1SK: `STATUS#ACTIVE#DATE#${now}`,\n      GSI2PK: `COURSE#${courseId}#ENROLLMENTS`,\n      GSI2SK: `USER#${userId}`,\n      GSI3PK: 'ENROLLMENTS',\n      GSI3SK: `DATE#${now}#ENROLL#${enrollmentId}`,\n    };\n\n    await docClient.send(\n      new PutCommand({\n        TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n        Item: enrollmentData,\n      })\n    );\n\n    // Update course student count\n    await docClient.send(\n      new UpdateCommand({\n        TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n        Key: { PK: `COURSE#${courseId}`, SK: 'METADATA' },\n        UpdateExpression: 'SET totalStudents = totalStudents + :inc',\n        ExpressionAttributeValues: { ':inc': 1 },\n      })\n    );\n\n    return {\n      statusCode: 200,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({\n        message: 'Payment confirmed and enrollment created',\n        payment: paymentData,\n        enrollment: enrollmentData,\n      }),\n    };\n  } catch (error) {\n    console.error('Error:', error);\n    return {\n      statusCode: 500,\n      headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n      body: JSON.stringify({\n        error: 'Internal server error',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      }),\n    };\n  }\n};", "import crypto from 'crypto';\nconst rnds8Pool = new Uint8Array(256); // # of random values to pre-allocate\n\nlet poolPtr = rnds8Pool.length;\nexport default function rng() {\n  if (poolPtr > rnds8Pool.length - 16) {\n    crypto.randomFillSync(rnds8Pool);\n    poolPtr = 0;\n  }\n\n  return rnds8Pool.slice(poolPtr, poolPtr += 16);\n}", "import validate from './validate.js';\n/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\n\nconst byteToHex = [];\n\nfor (let i = 0; i < 256; ++i) {\n  byteToHex.push((i + 0x100).toString(16).slice(1));\n}\n\nexport function unsafeStringify(arr, offset = 0) {\n  // Note: Be careful editing this code!  It's been tuned for performance\n  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434\n  return byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]];\n}\n\nfunction stringify(arr, offset = 0) {\n  const uuid = unsafeStringify(arr, offset); // Consistency check for valid UUID.  If this throws, it's likely due to one\n  // of the following:\n  // - One or more input array values don't map to a hex octet (leading to\n  // \"undefined\" in the uuid)\n  // - Invalid input values for the RFC `version` or `variant` fields\n\n  if (!validate(uuid)) {\n    throw TypeError('Stringified UUID is invalid');\n  }\n\n  return uuid;\n}\n\nexport default stringify;", "import crypto from 'crypto';\nexport default {\n  randomUUID: crypto.randomUUID\n};", "import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\n\nfunction v4(options, buf, offset) {\n  if (native.randomUUID && !buf && !options) {\n    return native.randomUUID();\n  }\n\n  options = options || {};\n  const rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n\n  rnds[6] = rnds[6] & 0x0f | 0x40;\n  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided\n\n  if (buf) {\n    offset = offset || 0;\n\n    for (let i = 0; i < 16; ++i) {\n      buf[offset + i] = rnds[i];\n    }\n\n    return buf;\n  }\n\n  return unsafeStringify(rnds);\n}\n\nexport default v4;"],
  "mappings": "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",
  "names": ["crypto", "import_crypto", "crypto"]
}

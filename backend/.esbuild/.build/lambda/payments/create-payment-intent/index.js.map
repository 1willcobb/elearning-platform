{
  "version": 3,
  "sources": ["../../../../../lambda/payments/create-payment-intent/index.ts"],
  "sourcesContent": ["import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, GetCommand } from '@aws-sdk/lib-dynamodb';\n\nconst dynamoClient = new DynamoDBClient({\n  region: process.env.AWS_REGION || 'us-east-1',\n  ...(process.env.STAGE === 'local' && {\n    endpoint: 'http://localhost:8000',\n    credentials: { accessKeyId: 'local', secretAccessKey: 'local' },\n  }),\n});\n\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\n\nexport const handler = async (\n  event: APIGatewayProxyEvent\n): Promise<APIGatewayProxyResult> => {\n  try {\n    if (!event.body) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'Request body is required' }),\n      };\n    }\n\n    const body = JSON.parse(event.body);\n    const { courseId, couponCode } = body;\n    const userId = 'user123'; // TODO: Get from JWT\n\n    if (!courseId) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'courseId is required' }),\n      };\n    }\n\n    // Get course details\n    const course = await docClient.send(\n      new GetCommand({\n        TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n        Key: { PK: `COURSE#${courseId}`, SK: 'METADATA' },\n      })\n    );\n\n    if (!course.Item) {\n      return {\n        statusCode: 404,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'Course not found' }),\n      };\n    }\n\n    let finalPrice = course.Item.discountPrice || course.Item.price;\n    let discountApplied = 0;\n    let couponData = null;\n\n    // Apply coupon if provided\n    if (couponCode) {\n      const coupon = await docClient.send(\n        new GetCommand({\n          TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n          Key: { PK: `COUPON#${couponCode}`, SK: 'METADATA' },\n        })\n      );\n\n      if (coupon.Item && coupon.Item.isActive) {\n        const now = new Date();\n        const validFrom = new Date(coupon.Item.validFrom);\n        const validUntil = new Date(coupon.Item.validUntil);\n\n        if (now >= validFrom && now <= validUntil && coupon.Item.usedCount < coupon.Item.maxUses) {\n          couponData = coupon.Item;\n          \n          if (coupon.Item.type === 'PERCENTAGE') {\n            discountApplied = (finalPrice * coupon.Item.discountValue) / 100;\n          } else {\n            discountApplied = coupon.Item.discountValue;\n          }\n\n          if (coupon.Item.maxDiscountAmount) {\n            discountApplied = Math.min(discountApplied, coupon.Item.maxDiscountAmount);\n          }\n\n          finalPrice = Math.max(0, finalPrice - discountApplied);\n        }\n      }\n    }\n\n    // In production, this would create a Stripe payment intent\n    // For now, we'll return a mock payment intent\n    const paymentIntent = {\n      id: `pi_mock_${Date.now()}`,\n      clientSecret: `pi_mock_${Date.now()}_secret`,\n      amount: Math.round(finalPrice * 100), // Convert to cents\n      currency: course.Item.currency.toLowerCase(),\n      status: 'requires_payment_method',\n    };\n\n    return {\n      statusCode: 200,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({\n        paymentIntent,\n        course: {\n          id: courseId,\n          title: course.Item.title,\n          originalPrice: course.Item.price,\n          discountPrice: course.Item.discountPrice,\n          finalPrice,\n          discountApplied,\n          couponApplied: couponData?.couponCode || null,\n        },\n      }),\n    };\n  } catch (error) {\n    console.error('Error:', error);\n    return {\n      statusCode: 500,\n      headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n      body: JSON.stringify({\n        error: 'Internal server error',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      }),\n    };\n  }\n};"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,6BAA+B;AAC/B,0BAAmD;AAEnD,IAAM,eAAe,IAAI,sCAAe;AAAA,EACtC,QAAQ,QAAQ,IAAI,cAAc;AAAA,EAClC,GAAI,QAAQ,IAAI,UAAU,WAAW;AAAA,IACnC,UAAU;AAAA,IACV,aAAa,EAAE,aAAa,SAAS,iBAAiB,QAAQ;AAAA,EAChE;AACF,CAAC;AAED,IAAM,YAAY,2CAAuB,KAAK,YAAY;AAEnD,IAAM,UAAU,OACrB,UACmC;AACnC,MAAI;AACF,QAAI,CAAC,MAAM,MAAM;AACf,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS,EAAE,gBAAgB,oBAAoB,+BAA+B,IAAI;AAAA,QAClF,MAAM,KAAK,UAAU,EAAE,OAAO,2BAA2B,CAAC;AAAA,MAC5D;AAAA,IACF;AAEA,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI;AAClC,UAAM,EAAE,UAAU,WAAW,IAAI;AACjC,UAAM,SAAS;AAEf,QAAI,CAAC,UAAU;AACb,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS,EAAE,gBAAgB,oBAAoB,+BAA+B,IAAI;AAAA,QAClF,MAAM,KAAK,UAAU,EAAE,OAAO,uBAAuB,CAAC;AAAA,MACxD;AAAA,IACF;AAGA,UAAM,SAAS,MAAM,UAAU;AAAA,MAC7B,IAAI,+BAAW;AAAA,QACb,WAAW,QAAQ,IAAI,cAAc;AAAA,QACrC,KAAK,EAAE,IAAI,UAAU,QAAQ,IAAI,IAAI,WAAW;AAAA,MAClD,CAAC;AAAA,IACH;AAEA,QAAI,CAAC,OAAO,MAAM;AAChB,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS,EAAE,gBAAgB,oBAAoB,+BAA+B,IAAI;AAAA,QAClF,MAAM,KAAK,UAAU,EAAE,OAAO,mBAAmB,CAAC;AAAA,MACpD;AAAA,IACF;AAEA,QAAI,aAAa,OAAO,KAAK,iBAAiB,OAAO,KAAK;AAC1D,QAAI,kBAAkB;AACtB,QAAI,aAAa;AAGjB,QAAI,YAAY;AACd,YAAM,SAAS,MAAM,UAAU;AAAA,QAC7B,IAAI,+BAAW;AAAA,UACb,WAAW,QAAQ,IAAI,cAAc;AAAA,UACrC,KAAK,EAAE,IAAI,UAAU,UAAU,IAAI,IAAI,WAAW;AAAA,QACpD,CAAC;AAAA,MACH;AAEA,UAAI,OAAO,QAAQ,OAAO,KAAK,UAAU;AACvC,cAAM,MAAM,oBAAI,KAAK;AACrB,cAAM,YAAY,IAAI,KAAK,OAAO,KAAK,SAAS;AAChD,cAAM,aAAa,IAAI,KAAK,OAAO,KAAK,UAAU;AAElD,YAAI,OAAO,aAAa,OAAO,cAAc,OAAO,KAAK,YAAY,OAAO,KAAK,SAAS;AACxF,uBAAa,OAAO;AAEpB,cAAI,OAAO,KAAK,SAAS,cAAc;AACrC,8BAAmB,aAAa,OAAO,KAAK,gBAAiB;AAAA,UAC/D,OAAO;AACL,8BAAkB,OAAO,KAAK;AAAA,UAChC;AAEA,cAAI,OAAO,KAAK,mBAAmB;AACjC,8BAAkB,KAAK,IAAI,iBAAiB,OAAO,KAAK,iBAAiB;AAAA,UAC3E;AAEA,uBAAa,KAAK,IAAI,GAAG,aAAa,eAAe;AAAA,QACvD;AAAA,MACF;AAAA,IACF;AAIA,UAAM,gBAAgB;AAAA,MACpB,IAAI,WAAW,KAAK,IAAI,CAAC;AAAA,MACzB,cAAc,WAAW,KAAK,IAAI,CAAC;AAAA,MACnC,QAAQ,KAAK,MAAM,aAAa,GAAG;AAAA;AAAA,MACnC,UAAU,OAAO,KAAK,SAAS,YAAY;AAAA,MAC3C,QAAQ;AAAA,IACV;AAEA,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,+BAA+B;AAAA,MACjC;AAAA,MACA,MAAM,KAAK,UAAU;AAAA,QACnB;AAAA,QACA,QAAQ;AAAA,UACN,IAAI;AAAA,UACJ,OAAO,OAAO,KAAK;AAAA,UACnB,eAAe,OAAO,KAAK;AAAA,UAC3B,eAAe,OAAO,KAAK;AAAA,UAC3B;AAAA,UACA;AAAA,UACA,eAAe,YAAY,cAAc;AAAA,QAC3C;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,MAAM,UAAU,KAAK;AAC7B,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS,EAAE,gBAAgB,oBAAoB,+BAA+B,IAAI;AAAA,MAClF,MAAM,KAAK,UAAU;AAAA,QACnB,OAAO;AAAA,QACP,SAAS,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MACpD,CAAC;AAAA,IACH;AAAA,EACF;AACF;",
  "names": []
}

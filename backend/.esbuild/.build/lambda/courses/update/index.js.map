{
  "version": 3,
  "sources": ["../../../../../lambda/courses/update/index.ts"],
  "sourcesContent": ["import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, GetCommand, UpdateCommand } from '@aws-sdk/lib-dynamodb';\n\nconst dynamoClient = new DynamoDBClient({\n  region: process.env.AWS_REGION || 'us-east-1',\n  ...(process.env.STAGE === 'local' && {\n    endpoint: 'http://localhost:8000',\n    credentials: {\n      accessKeyId: 'local',\n      secretAccessKey: 'local',\n    },\n  }),\n});\n\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\n\nexport const handler = async (\n  event: APIGatewayProxyEvent\n): Promise<APIGatewayProxyResult> => {\n  try {\n    const courseId = event.pathParameters?.courseId;\n\n    if (!courseId) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'courseId is required' }),\n      };\n    }\n\n    if (!event.body) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'Request body is required' }),\n      };\n    }\n\n    // Check if course exists\n    const existingCourse = await docClient.send(\n      new GetCommand({\n        TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n        Key: {\n          PK: `COURSE#${courseId}`,\n          SK: 'METADATA',\n        },\n      })\n    );\n\n    if (!existingCourse.Item) {\n      return {\n        statusCode: 404,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'Course not found' }),\n      };\n    }\n\n    const body = JSON.parse(event.body);\n    const now = new Date().toISOString();\n\n    // Build update expression dynamically\n    const updateExpressions: string[] = [];\n    const expressionAttributeNames: Record<string, string> = {};\n    const expressionAttributeValues: Record<string, any> = {};\n\n    const allowedFields = [\n      'title', 'description', 'longDescription', 'category', 'subcategory',\n      'tags', 'level', 'language', 'price', 'currency', 'discountPrice',\n      'discountEndDate', 'thumbnail', 'previewVideo', 'requirements',\n      'learningOutcomes', 'targetAudience', 'status', 'isPublished'\n    ];\n\n    allowedFields.forEach((field) => {\n      if (body[field] !== undefined) {\n        updateExpressions.push(`#${field} = :${field}`);\n        expressionAttributeNames[`#${field}`] = field;\n        expressionAttributeValues[`:${field}`] = body[field];\n      }\n    });\n\n    if (updateExpressions.length === 0) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'No valid fields to update' }),\n      };\n    }\n\n    // Always update updatedAt\n    updateExpressions.push('#updatedAt = :updatedAt');\n    expressionAttributeNames['#updatedAt'] = 'updatedAt';\n    expressionAttributeValues[':updatedAt'] = now;\n\n    // Update GSI indexes if category or status changed\n    if (body.category) {\n      updateExpressions.push('#GSI1PK = :GSI1PK');\n      expressionAttributeNames['#GSI1PK'] = 'GSI1PK';\n      expressionAttributeValues[':GSI1PK'] = `CATEGORY#${body.category}`;\n    }\n\n    if (body.status) {\n      updateExpressions.push('#GSI3PK = :GSI3PK');\n      expressionAttributeNames['#GSI3PK'] = 'GSI3PK';\n      expressionAttributeValues[':GSI3PK'] = `STATUS#${body.status}`;\n    }\n\n    const result = await docClient.send(\n      new UpdateCommand({\n        TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n        Key: {\n          PK: `COURSE#${courseId}`,\n          SK: 'METADATA',\n        },\n        UpdateExpression: `SET ${updateExpressions.join(', ')}`,\n        ExpressionAttributeNames: expressionAttributeNames,\n        ExpressionAttributeValues: expressionAttributeValues,\n        ReturnValues: 'ALL_NEW',\n      })\n    );\n\n    return {\n      statusCode: 200,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({\n        message: 'Course updated successfully',\n        course: result.Attributes,\n      }),\n    };\n  } catch (error) {\n    console.error('Error:', error);\n    return {\n      statusCode: 500,\n      headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n      body: JSON.stringify({\n        error: 'Internal server error',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      }),\n    };\n  }\n};"],
  "mappings": "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",
  "names": []
}

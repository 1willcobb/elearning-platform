{
  "version": 3,
  "sources": ["../../../../../lambda/progress/update/index.ts"],
  "sourcesContent": ["import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, PutCommand, GetCommand, UpdateCommand } from '@aws-sdk/lib-dynamodb';\n\nconst dynamoClient = new DynamoDBClient({\n  region: process.env.AWS_REGION || 'us-east-1',\n  ...(process.env.STAGE === 'local' && {\n    endpoint: 'http://localhost:8000',\n    credentials: { accessKeyId: 'local', secretAccessKey: 'local' },\n  }),\n});\n\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\n\nexport const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {\n  try {\n    if (!event.body) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n        body: JSON.stringify({ error: 'Request body is required' }),\n      };\n    }\n\n    const body = JSON.parse(event.body);\n    const { courseId, lessonId, watchTime, completed } = body;\n    const userId = 'user123'; // TODO: Get from JWT\n    const now = new Date().toISOString();\n\n    const progressData = {\n      PK: `USER#${userId}`,\n      SK: `PROGRESS#${courseId}#lesson${lessonId}`,\n      EntityType: 'LessonProgress',\n      userId,\n      courseId,\n      lessonId,\n      status: completed ? 'COMPLETED' : 'IN_PROGRESS',\n      watchTime,\n      completedAt: completed ? now : null,\n      lastAccessedAt: now,\n      GSI1PK: `USER#${userId}#COURSE#${courseId}`,\n      GSI1SK: `PROGRESS#${lessonId}`,\n    };\n\n    await docClient.send(\n      new PutCommand({\n        TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n        Item: progressData,\n      })\n    );\n\n    // Update enrollment progress if lesson completed\n    if (completed) {\n      const enrollment = await docClient.send(\n        new GetCommand({\n          TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n          Key: { PK: `USER#${userId}`, SK: `ENROLLMENT#${courseId}` },\n        })\n      );\n\n      if (enrollment.Item) {\n        const completedLessons = (enrollment.Item.progress?.completedLessons || 0) + 1;\n        const totalLessons = enrollment.Item.progress?.totalLessons || 1;\n        const completionPercentage = Math.round((completedLessons / totalLessons) * 100);\n\n        await docClient.send(\n          new UpdateCommand({\n            TableName: process.env.TABLE_NAME || 'ELearningPlatform-local',\n            Key: { PK: `USER#${userId}`, SK: `ENROLLMENT#${courseId}` },\n            UpdateExpression: 'SET progress.completedLessons = :completed, progress.completionPercentage = :percentage, lastAccessedAt = :now',\n            ExpressionAttributeValues: {\n              ':completed': completedLessons,\n              ':percentage': completionPercentage,\n              ':now': now,\n            },\n          })\n        );\n      }\n    }\n\n    return {\n      statusCode: 200,\n      headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n      body: JSON.stringify({ message: 'Progress updated', progress: progressData }),\n    };\n  } catch (error) {\n    console.error('Error:', error);\n    return {\n      statusCode: 500,\n      headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },\n      body: JSON.stringify({ error: 'Internal server error', message: error instanceof Error ? error.message : 'Unknown error' }),\n    };\n  }\n};\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,6BAA+B;AAC/B,0BAA8E;AAE9E,IAAM,eAAe,IAAI,sCAAe;AAAA,EACtC,QAAQ,QAAQ,IAAI,cAAc;AAAA,EAClC,GAAI,QAAQ,IAAI,UAAU,WAAW;AAAA,IACnC,UAAU;AAAA,IACV,aAAa,EAAE,aAAa,SAAS,iBAAiB,QAAQ;AAAA,EAChE;AACF,CAAC;AAED,IAAM,YAAY,2CAAuB,KAAK,YAAY;AAEnD,IAAM,UAAU,OAAO,UAAgE;AAC5F,MAAI;AACF,QAAI,CAAC,MAAM,MAAM;AACf,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS,EAAE,gBAAgB,oBAAoB,+BAA+B,IAAI;AAAA,QAClF,MAAM,KAAK,UAAU,EAAE,OAAO,2BAA2B,CAAC;AAAA,MAC5D;AAAA,IACF;AAEA,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI;AAClC,UAAM,EAAE,UAAU,UAAU,WAAW,UAAU,IAAI;AACrD,UAAM,SAAS;AACf,UAAM,OAAM,oBAAI,KAAK,GAAE,YAAY;AAEnC,UAAM,eAAe;AAAA,MACnB,IAAI,QAAQ,MAAM;AAAA,MAClB,IAAI,YAAY,QAAQ,UAAU,QAAQ;AAAA,MAC1C,YAAY;AAAA,MACZ;AAAA,MACA;AAAA,MACA;AAAA,MACA,QAAQ,YAAY,cAAc;AAAA,MAClC;AAAA,MACA,aAAa,YAAY,MAAM;AAAA,MAC/B,gBAAgB;AAAA,MAChB,QAAQ,QAAQ,MAAM,WAAW,QAAQ;AAAA,MACzC,QAAQ,YAAY,QAAQ;AAAA,IAC9B;AAEA,UAAM,UAAU;AAAA,MACd,IAAI,+BAAW;AAAA,QACb,WAAW,QAAQ,IAAI,cAAc;AAAA,QACrC,MAAM;AAAA,MACR,CAAC;AAAA,IACH;AAGA,QAAI,WAAW;AACb,YAAM,aAAa,MAAM,UAAU;AAAA,QACjC,IAAI,+BAAW;AAAA,UACb,WAAW,QAAQ,IAAI,cAAc;AAAA,UACrC,KAAK,EAAE,IAAI,QAAQ,MAAM,IAAI,IAAI,cAAc,QAAQ,GAAG;AAAA,QAC5D,CAAC;AAAA,MACH;AAEA,UAAI,WAAW,MAAM;AACnB,cAAM,oBAAoB,WAAW,KAAK,UAAU,oBAAoB,KAAK;AAC7E,cAAM,eAAe,WAAW,KAAK,UAAU,gBAAgB;AAC/D,cAAM,uBAAuB,KAAK,MAAO,mBAAmB,eAAgB,GAAG;AAE/E,cAAM,UAAU;AAAA,UACd,IAAI,kCAAc;AAAA,YAChB,WAAW,QAAQ,IAAI,cAAc;AAAA,YACrC,KAAK,EAAE,IAAI,QAAQ,MAAM,IAAI,IAAI,cAAc,QAAQ,GAAG;AAAA,YAC1D,kBAAkB;AAAA,YAClB,2BAA2B;AAAA,cACzB,cAAc;AAAA,cACd,eAAe;AAAA,cACf,QAAQ;AAAA,YACV;AAAA,UACF,CAAC;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAEA,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS,EAAE,gBAAgB,oBAAoB,+BAA+B,IAAI;AAAA,MAClF,MAAM,KAAK,UAAU,EAAE,SAAS,oBAAoB,UAAU,aAAa,CAAC;AAAA,IAC9E;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,MAAM,UAAU,KAAK;AAC7B,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS,EAAE,gBAAgB,oBAAoB,+BAA+B,IAAI;AAAA,MAClF,MAAM,KAAK,UAAU,EAAE,OAAO,yBAAyB,SAAS,iBAAiB,QAAQ,MAAM,UAAU,gBAAgB,CAAC;AAAA,IAC5H;AAAA,EACF;AACF;",
  "names": []
}

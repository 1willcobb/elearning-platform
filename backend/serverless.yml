service: elearning-platform
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  stage: ${opt:stage, 'local'}
  region: ${opt:region, 'us-east-1'}
  
  environment:
    TABLE_NAME: ${self:custom.tableName}
    VIDEO_BUCKET: ${self:custom.videoBucket}
    UPLOADS_BUCKET: ${self:custom.uploadsBucket}
    STAGE: ${self:provider.stage}
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.tableName}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.tableName}/index/*
        
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource:
            - arn:aws:s3:::${self:custom.videoBucket}/*
            - arn:aws:s3:::${self:custom.uploadsBucket}/*

custom:
  tableName: ELearningPlatform-${self:provider.stage}
  videoBucket: elearning-videos-${self:provider.stage}-${aws:accountId}
  uploadsBucket: elearning-uploads-${self:provider.stage}-${aws:accountId}
  
  # Serverless Offline Configuration
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    websocketPort: 3003
    noPrependStageInUrl: true
  
  # ESBuild Configuration
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude:
      - aws-sdk
      - '@aws-sdk/*'
    target: node18
    platform: node
    concurrency: 10

plugins:
  - serverless-esbuild
  - serverless-offline

functions:
  # ============================================
  # COURSE FUNCTIONS
  # ============================================
  createCourse:
    handler: lambda/courses/create/index.handler
    description: Create a new course
    events:
      - http:
          method: POST
          path: courses
          cors: true
  
  updateCourse:
    handler: lambda/courses/update/index.handler
    description: Update an existing course
    events:
      - http:
          method: PUT
          path: courses/{courseId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  getCourse:
    handler: lambda/courses/get/index.handler
    description: Get a single course
    events:
      - http:
          method: GET
          path: courses/{courseId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  listCourses:
    handler: lambda/courses/list/index.handler
    description: List all courses
    events:
      - http:
          method: GET
          path: courses
          cors: true
  
  deleteCourse:
    handler: lambda/courses/delete/index.handler
    description: Delete a course
    events:
      - http:
          method: DELETE
          path: courses/{courseId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  # ============================================
  # LESSON FUNCTIONS
  # ============================================
  createLesson:
    handler: lambda/lessons/create/index.handler
    description: Create a new lesson
    events:
      - http:
          method: POST
          path: courses/{courseId}/lessons
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  updateLesson:
    handler: lambda/lessons/update/index.handler
    description: Update a lesson
    events:
      - http:
          method: PUT
          path: courses/{courseId}/lessons/{lessonId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
                lessonId: true
  
  reorderLessons:
    handler: lambda/lessons/reorder/index.handler
    description: Reorder lessons in a section
    timeout: 30
    events:
      - http:
          method: POST
          path: courses/{courseId}/lessons/reorder
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  deleteLesson:
    handler: lambda/lessons/delete/index.handler
    description: Delete a lesson
    events:
      - http:
          method: DELETE
          path: courses/{courseId}/lessons/{lessonId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
                lessonId: true
  
  # ============================================
  # ENROLLMENT FUNCTIONS
  # ============================================
  enrollCourse:
    handler: lambda/enrollment/enroll/index.handler
    description: Enroll in a course
    events:
      - http:
          method: POST
          path: courses/{courseId}/enroll
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  unenrollCourse:
    handler: lambda/enrollment/unenroll/index.handler
    description: Unenroll from a course
    events:
      - http:
          method: POST
          path: courses/{courseId}/unenroll
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  # ============================================
  # PROGRESS FUNCTIONS
  # ============================================
  updateProgress:
    handler: lambda/progress/update/index.handler
    description: Update lesson progress
    events:
      - http:
          method: POST
          path: progress
          cors: true
  
  getProgress:
    handler: lambda/progress/get/index.handler
    description: Get course progress
    events:
      - http:
          method: GET
          path: progress/{courseId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  # ============================================
  # UPLOAD FUNCTIONS
  # ============================================
  getUploadUrl:
    handler: lambda/uploads/presigned-url/index.handler
    description: Generate presigned URL for uploads
    events:
      - http:
          method: POST
          path: uploads/presigned-url
          cors: true

# Optional: Resources for local development
resources:
  Conditions:
    IsLocal:
      Fn::Equals:
        - ${self:provider.stage}
        - local
  
  Resources:
    # DynamoDB Table (only for non-local stages)
    ELearningTable:
      Type: AWS::DynamoDB::Table
      Condition:
        Fn::Not:
          - Ref: IsLocal
      Properties:
        TableName: ${self:custom.tableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
          - AttributeName: GSI2SK
            AttributeType: S
          - AttributeName: GSI3PK
            AttributeType: S
          - AttributeName: GSI3SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI2
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
              - AttributeName: GSI2SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI3
            KeySchema:
              - AttributeName: GSI3PK
                KeyType: HASH
              - AttributeName: GSI3SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}
    
    # S3 Buckets (only for non-local stages)
    VideoBucket:
      Type: AWS::S3::Bucket
      Condition:
        Fn::Not:
          - Ref: IsLocal
      Properties:
        BucketName: ${self:custom.videoBucket}
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - HEAD
              AllowedHeaders:
                - '*'
    
    UploadsBucket:
      Type: AWS::S3::Bucket
      Condition:
        Fn::Not:
          - Ref: IsLocal
      Properties:
        BucketName: ${self:custom.uploadsBucket}
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedHeaders:
                - '*'
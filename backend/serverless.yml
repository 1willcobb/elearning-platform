service: elearning-platform
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  stage: ${opt:stage, 'local'}
  region: ${opt:region, 'us-east-1'}
  
  environment:
    TABLE_NAME: ${self:custom.tableName}
    VIDEO_BUCKET: ${self:custom.videoBucket}
    UPLOADS_BUCKET: ${self:custom.uploadsBucket}
    STAGE: ${self:provider.stage}
    JWT_SECRET: ${env:JWT_SECRET, 'your-secret-key-change-in-production'}
    JWT_REFRESH_SECRET: ${env:JWT_REFRESH_SECRET, 'your-refresh-secret-key-change-in-production'}
    FROM_EMAIL: ${env:FROM_EMAIL, 'noreply@elearning.com'}
    FRONTEND_URL: ${env:FRONTEND_URL, 'http://localhost:3000'}
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.tableName}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.tableName}/index/*
        
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource:
            - arn:aws:s3:::${self:custom.videoBucket}/*
            - arn:aws:s3:::${self:custom.uploadsBucket}/*

        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: '*'

custom:
  tableName: ELearningPlatform-${self:provider.stage}
  videoBucket: elearning-videos-${self:provider.stage}-${aws:accountId}
  uploadsBucket: elearning-uploads-${self:provider.stage}-${aws:accountId}
  
  # Serverless Offline Configuration
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    websocketPort: 3003
    noPrependStageInUrl: true
  
  # ESBuild Configuration
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude:
      - aws-sdk
      - '@aws-sdk/*'
    target: node18
    platform: node
    concurrency: 10

plugins:
  - serverless-esbuild
  - serverless-offline

functions:
  # ============================================
  # AUTH FUNCTIONS
  # ============================================
  register:
    handler: lambda/auth/register/index.handler
    events:
      - http:
          method: POST
          path: auth/register
          cors: true

  login:
    handler: lambda/auth/login/index.handler
    events:
      - http:
          method: POST
          path: auth/login
          cors: true

  refreshToken:
    handler: lambda/auth/refresh-token/index.handler
    events:
      - http:
          method: POST
          path: auth/refresh
          cors: true

  verifyToken:
    handler: lambda/auth/verify-token/index.handler
    events:
      - http:
          method: GET
          path: auth/verify
          cors: true

  # Password Reset
  requestPasswordReset:
    handler: lambda/auth/request-password-reset/index.handler
    events:
      - http:
          method: POST
          path: auth/password-reset/request
          cors: true

  verifyResetToken:
    handler: lambda/auth/verify-reset-token/index.handler
    events:
      - http:
          method: GET
          path: auth/password-reset/verify
          cors: true

  resetPassword:
    handler: lambda/auth/reset-password/index.handler
    events:
      - http:
          method: POST
          path: auth/password-reset/reset
          cors: true

  # ============================================
  # SESSION MANAGEMENT FUNCTIONS
  # ============================================
  listSessions:
    handler: lambda/sessions/list/index.handler
    events:
      - http:
          method: GET
          path: sessions
          cors: true

  revokeSession:
    handler: lambda/sessions/revoke/index.handler
    events:
      - http:
          method: DELETE
          path: sessions/{sessionId}
          cors: true

  revokeAllSessions:
    handler: lambda/sessions/revoke-all/index.handler
    events:
      - http:
          method: DELETE
          path: sessions
          cors: true

  # ============================================
  # SCHOOL FUNCTIONS
  # ============================================
  createSchool:
    handler: lambda/schools/create/index.handler
    events:
      - http:
          method: POST
          path: schools
          cors: true

  getMySchool:
    handler: lambda/schools/get-my-school/index.handler
    events:
      - http:
          method: GET
          path: schools/my-school
          cors: true

  getSchool:
    handler: lambda/schools/get/index.handler
    events:
      - http:
          method: GET
          path: schools/{schoolId}
          cors: true

  listSchools:
    handler: lambda/schools/list/index.handler
    events:
      - http:
          method: GET
          path: schools
          cors: true

  updateSchool:
    handler: lambda/schools/update/index.handler
    events:
      - http:
          method: PUT
          path: schools/{schoolId}
          cors: true

  deleteSchool:
    handler: lambda/schools/delete/index.handler
    events:
      - http:
          method: DELETE
          path: schools/{schoolId}
          cors: true

  # ============================================
  # SUPER ADMIN FUNCTIONS
  # ============================================
  adminCreateUser:
    handler: lambda/admin/create-user/index.handler
    events:
      - http:
          method: POST
          path: admin/users
          cors: true

  adminCreateSchool:
    handler: lambda/admin/create-school/index.handler
    events:
      - http:
          method: POST
          path: admin/schools
          cors: true

  adminManualEnroll:
    handler: lambda/admin/manual-enroll/index.handler
    events:
      - http:
          method: POST
          path: admin/enrollments
          cors: true

  adminUpdateUserRoles:
    handler: lambda/admin/update-user-roles/index.handler
    events:
      - http:
          method: PUT
          path: admin/users/roles
          cors: true

  adminListAllUsers:
    handler: lambda/admin/list-all-users/index.handler
    events:
      - http:
          method: GET
          path: admin/users
          cors: true

  adminListAllSchools:
    handler: lambda/admin/list-all-schools/index.handler
    events:
      - http:
          method: GET
          path: admin/schools
          cors: true

  adminDeleteUser:
    handler: lambda/admin/delete-user/index.handler
    events:
      - http:
          method: DELETE
          path: admin/users/{userId}
          cors: true

# ============================================
  # USER FUNCTIONS
  # ============================================
  createUserProfile:
    handler: lambda/users/create-profile/index.handler
    events:
      - http:
          method: POST
          path: users/profile
          cors: true
  
  getUserProfile:
    handler: lambda/users/get-profile/index.handler
    events:
      - http:
          method: GET
          path: users/{userId}
          cors: true
  
  updateUserProfile:
    handler: lambda/users/update-profile/index.handler
    events:
      - http:
          method: PUT
          path: users/{userId}/profile
          cors: true
  
  updateUserSettings:
    handler: lambda/users/update-settings/index.handler
    events:
      - http:
          method: PUT
          path: users/{userId}/settings
          cors: true
  
  # ============================================
  # SECTION FUNCTIONS
  # ============================================
  createSection:
    handler: lambda/sections/create/index.handler
    events:
      - http:
          method: POST
          path: courses/{courseId}/sections
          cors: true
  
  listSections:
    handler: lambda/sections/list/index.handler
    events:
      - http:
          method: GET
          path: courses/{courseId}/sections
          cors: true
  
  updateSection:
    handler: lambda/sections/update/index.handler
    events:
      - http:
          method: PUT
          path: courses/{courseId}/sections/{sectionId}
          cors: true
  
  deleteSection:
    handler: lambda/sections/delete/index.handler
    events:
      - http:
          method: DELETE
          path: courses/{courseId}/sections/{sectionId}
          cors: true
  
  reorderSections:
    handler: lambda/sections/reorder/index.handler
    events:
      - http:
          method: POST
          path: courses/{courseId}/sections/reorder
          cors: true
  
  # ============================================
  # PAYMENT FUNCTIONS
  # ============================================
  createPaymentIntent:
    handler: lambda/payments/create-payment-intent/index.handler
    events:
      - http:
          method: POST
          path: payments/intent
          cors: true
  
  confirmPayment:
    handler: lambda/payments/confirm-payment/index.handler
    events:
      - http:
          method: POST
          path: payments/confirm
          cors: true
  
  getPaymentHistory:
    handler: lambda/payments/get-payment-history/index.handler
    events:
      - http:
          method: GET
          path: payments/history/{userId}
          cors: true
  
  createCoupon:
    handler: lambda/payments/create-coupon/index.handler
    events:
      - http:
          method: POST
          path: coupons
          cors: true
  
  validateCoupon:
    handler: lambda/payments/validate-coupon/index.handler
    events:
      - http:
          method: GET
          path: coupons/{couponCode}/validate
          cors: true
  # ============================================
  # COURSE FUNCTIONS
  # ============================================
  createCourse:
    handler: lambda/courses/create/index.handler
    description: Create a new course
    events:
      - http:
          method: POST
          path: courses
          cors: true
  
  updateCourse:
    handler: lambda/courses/update/index.handler
    description: Update an existing course
    events:
      - http:
          method: PUT
          path: courses/{courseId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  getCourse:
    handler: lambda/courses/get/index.handler
    description: Get a single course
    events:
      - http:
          method: GET
          path: courses/{courseId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  listCourses:
    handler: lambda/courses/list/index.handler
    description: List all courses
    events:
      - http:
          method: GET
          path: courses
          cors: true
  
  deleteCourse:
    handler: lambda/courses/delete/index.handler
    description: Delete a course
    events:
      - http:
          method: DELETE
          path: courses/{courseId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  # ============================================
  # LESSON FUNCTIONS
  # ============================================
  createLesson:
    handler: lambda/lessons/create/index.handler
    description: Create a new lesson
    events:
      - http:
          method: POST
          path: courses/{courseId}/lessons
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  updateLesson:
    handler: lambda/lessons/update/index.handler
    description: Update a lesson
    events:
      - http:
          method: PUT
          path: courses/{courseId}/lessons/{lessonId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
                lessonId: true
  
  reorderLessons:
    handler: lambda/lessons/reorder/index.handler
    description: Reorder lessons in a section
    timeout: 30
    events:
      - http:
          method: POST
          path: courses/{courseId}/lessons/reorder
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  deleteLesson:
    handler: lambda/lessons/delete/index.handler
    description: Delete a lesson
    events:
      - http:
          method: DELETE
          path: courses/{courseId}/lessons/{lessonId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
                lessonId: true
  
  # ============================================
  # ENROLLMENT FUNCTIONS
  # ============================================
  enrollCourse:
    handler: lambda/enrollment/enroll/index.handler
    description: Enroll in a course
    events:
      - http:
          method: POST
          path: courses/{courseId}/enroll
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  unenrollCourse:
    handler: lambda/enrollment/unenroll/index.handler
    description: Unenroll from a course
    events:
      - http:
          method: POST
          path: courses/{courseId}/unenroll
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  # ============================================
  # PROGRESS FUNCTIONS
  # ============================================
  updateProgress:
    handler: lambda/progress/update/index.handler
    description: Update lesson progress
    events:
      - http:
          method: POST
          path: progress
          cors: true
  
  getProgress:
    handler: lambda/progress/get/index.handler
    description: Get course progress
    events:
      - http:
          method: GET
          path: progress/{courseId}
          cors: true
          request:
            parameters:
              paths:
                courseId: true
  
  # ============================================
  # UPLOAD FUNCTIONS
  # ============================================
  getUploadUrl:
    handler: lambda/uploads/presigned-url/index.handler
    description: Generate presigned URL for uploads
    events:
      - http:
          method: POST
          path: uploads/presigned-url
          cors: true

# Optional: Resources for local development
resources:
  Conditions:
    IsLocal:
      Fn::Equals:
        - ${self:provider.stage}
        - local
  
  Resources:
    # DynamoDB Table (only for non-local stages)
    ELearningTable:
      Type: AWS::DynamoDB::Table
      Condition:
        Fn::Not:
          - Ref: IsLocal
      Properties:
        TableName: ${self:custom.tableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
          - AttributeName: GSI2SK
            AttributeType: S
          - AttributeName: GSI3PK
            AttributeType: S
          - AttributeName: GSI3SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI2
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
              - AttributeName: GSI2SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI3
            KeySchema:
              - AttributeName: GSI3PK
                KeyType: HASH
              - AttributeName: GSI3SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}
    
    # S3 Buckets (only for non-local stages)
    VideoBucket:
      Type: AWS::S3::Bucket
      Condition:
        Fn::Not:
          - Ref: IsLocal
      Properties:
        BucketName: ${self:custom.videoBucket}
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - HEAD
              AllowedHeaders:
                - '*'
    
    UploadsBucket:
      Type: AWS::S3::Bucket
      Condition:
        Fn::Not:
          - Ref: IsLocal
      Properties:
        BucketName: ${self:custom.uploadsBucket}
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedHeaders:
                - '*'